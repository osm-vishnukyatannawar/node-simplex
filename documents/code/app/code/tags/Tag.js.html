<!DOCTYPE html>
<html>
<head>
  <title>Tag.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../", thisFile = "app/code/tags/Tag.js", defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>
  <script src="../../../fileSearch.js"></script>
  <link rel="stylesheet" href="../../../fileSearch.css" />
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>Tag.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<p>Custom Models</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_base_path</span> <span class="o">+</span> <span class="s1">&#39;lib/model&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_base_path</span> <span class="o">+</span> <span class="s1">&#39;logger&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-uuid&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">__</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">AppError</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_base_path</span> <span class="o">+</span> <span class="s1">&#39;lib/app-error&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">tagProp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_code_path</span> <span class="o">+</span> <span class="s1">&#39;tags/Properties&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">Tag</span><span class="p">(</span><span class="nx">objToBind</span><span class="p">,</span> <span class="nx">requestParameters</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Model</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">properties</span><span class="p">,</span> <span class="nx">objToBind</span><span class="p">,</span> <span class="nx">requestParameters</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Tag</span><span class="p">,</span> <span class="nx">Model</span><span class="p">);</span>

<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">properties</span> <span class="o">=</span> <span class="nx">tagProp</span><span class="p">;</span>

<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTagConfig</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">serialNum</span><span class="p">,</span> <span class="nx">orgID</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">serialNum</span><span class="p">)</span> <span class="o">||</span> <span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">orgID</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="k">this</span>
      <span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;badRequest&#39;</span><span class="p">),</span>
      <span class="s1">&#39;Please send the serial number and the organization ID of the tag.&#39;</span><span class="p">,</span> <span class="p">{}</span>
    <span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span>
    <span class="s1">&#39;SELECT config.tag_config_params_recid tagConfigParamsRecId, version_num versionNum,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; (SELECT device_id FROM device_types WHERE device_type_recid = config.device_type_recid)  deviceID,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.customer_id customerID, config.url_home url_home, config.push_button_actions pushButtonActions,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.min_maint_interval_sec minMaintenanceIntervalSec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.maint_interval_pluggedin_sec maintenanceIntervalPluggedInSec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.maint_interval_unplugged_sec maintenanceIntervalUnpluggedSec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.maint_interval_lowbatt_sec maintenanceIntervalLowBattSec, config.pluggedin_actions pluggedInActions,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.unplugged_actions unPluggedActions, config.regulatory_domain_id_enum regDomain,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.ccx_vendor_id ccxVendorID, config.wifi_ccx_channels wifiCCXChannels,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.ccx_battery_report_option ccxBatteryReportOption, config.ccx_report_options ccxReportOptions,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.min_beacon_interval_sec minBeaconIntervalSec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.wifi_pluggedin_beacon_interval_sec wifiPluggedInBeaconIntervalSec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.wifi_unplugged_beacon_interval_sec wifiUnpluggedBeaconIntervalSec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.wifi_lowbatt_beacon_interval_sec   wifiLowBattBeaconIntervalSec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.pkt_spacing_ms pktSpacingms, config.wifi_num_pkts_per_chan wifiNumPktsperChan,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.wifi_tx_power_dbm wifiTxPowerdBm, config.accel_enable accelEnable,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.accel_motion_time_sec accelMotionTimeSec, config.accel_motion_update_sec accelMotionUpdateSec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.ir_enable irEnable, config.lf_enable lfEnable, config.tamper_det_enable tamperDetEnable,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.current_meas_en currentMeasEn, config.max_pim_current_samples maxPimCurrentSamples&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; FROM tag_config_params config&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; INNER JOIN tag_info AS info ON info.tag_config_params_recid = config.tag_config_params_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; WHERE info.tag_serial_num = ? AND info.organization_id = ?;&#39;</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getResult</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">[</span><span class="nx">serialNum</span><span class="p">,</span> <span class="nx">orgID</span><span class="p">],</span>
    <span class="nx">cb</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTagConfigSecondaryDetails</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">serialNum</span><span class="p">,</span> <span class="nx">orgID</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">serialNum</span><span class="p">)</span> <span class="o">||</span> <span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">orgID</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="k">this</span>
      <span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;badRequest&#39;</span><span class="p">),</span>
      <span class="s1">&#39;Please send the serial number and the organization ID of the tag.&#39;</span><span class="p">,</span> <span class="p">{}</span>
    <span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span>
    <span class="s1">&#39; SELECT config.tag_config_params_recid tagConfigParamsRecId1,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; nwparams.server_ip_addr serverIPAddr, nwparams.num_dns_servers numDNS_Servers,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; nwparams.dns_ip_addr1 DNS_IP_Addr1, nwparams.dns_ip_addr2 DNS_IP_Addr2,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; nwparams.network_name networkName, nwparams.network_ssid networkSSID,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; nwparams.passphrase passphrase, nwparams.network_security networkSecurity,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; nwparams.addr_type addrtype, nwparams.tag_static_ip_addr tagStaticIPAddr,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; bleconfig.ble_enable bleEnable, bleconfig.ble_gaprole_min_conninterval_ms bleGapRoleMinConnIntervalms,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; bleconfig.ble_gaprole_max_conninterval_ms bleGapRoleMaxConnIntervalms,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; bleconfig.ble_gaprole_slave_latency bleGapRoleSlaveLatency,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; bleconfig.ble_limited_advert_ontime_sec bleLimitedAdvertOnTimeSec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; bleconfig.ble_limited_advert_intervaltime_ms bleLimitedAdvertIntervalTimems,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; bleconfig.ble_general_advert_intervaltime_ms bleGeneralAdvertIntervalTimems,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; bleconfig.ble_lowbatt_advert_intervaltime_ms bleLowBattAdvertIntervalTimems,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; bleconfig.ble_desired_connection_timeout_ms bleDesiredConnectionTimeoutms,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; bleconfig.ble_advert_offtime_ms advertOffTimems, bleconfig.ble_passkey blePasskey,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; findparams.buzzer_Freq_Hz buzzerFreqHz, findparams.buzzer_ontime_msec buzzerOnTime_msec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; findparams.buzzer_offtime_msec buzzerOffTime_msec, findparams.buzzer_cnt buzzerCnt,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; findparams.led_ontime_msec ledOnTime_msec, findparams.led_offtime_msec ledOffTime_msec,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; findparams.led_cnt ledCnt, currthresh.thresh_off threshOff,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; currthresh.thresh_inactive threshInact, currthresh.thresh_active threshActive,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.hist_config_enable histEnable, config.tag_hist_reset_rule_id_enum histResetRule,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; config.hist_thresh_1 histThresh, pimconfig.pimconfig_enable pimEnable,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; pimconfig.tag_pim_trig_type_id_enum pimTrigger, pimconfig.elapsed_time_10ms elapsedTime_10ms,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; pimconfig.iir_filter_mhz iirFilt_mHz, pimconfig.rms_diff_thresh_ma rmsDiffThresh_mA,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; pimconfig.trig_delay_10ms trigDly_10ms, pimconfig.samp_rate_hz sampRateHz,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; pimconfig.meas_dur_10ms measDur_10ms, batteryConfig.battery_rechargelevel_percent batteryRechargeLevelPercent,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; batteryConfig.battery_chargelevel_percent batteryChargeLevelPercent,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; batteryConfig.battery_threshlow_alert batteryThreshLowAlert,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; batteryConfig.battery_threshcritical_alert batteryThreshCriticalAlert&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; FROM tag_config_params config&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; LEFT JOIN  wifi_network_params nwparams ON nwparams.wifi_network_params_recid = config.wifi_network_params_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; LEFT JOIN tag_ble_config bleconfig ON bleconfig.tag_ble_config_recid = config.tag_ble_config_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; LEFT JOIN tag_find_params findparams ON findparams.tag_find_param_recid = config.tag_find_param_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; LEFT JOIN tag_current_thresh currthresh ON  currthresh.tag_current_thresh_recid = config.tag_current_thresh_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; LEFT JOIN tag_pim_config pimconfig ON pimconfig.tag_pim_config_recid = config.tag_pim_config_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; LEFT JOIN tag_battery_config batteryConfig ON batteryConfig.tag_battery_config_recid = config.tag_battery_config_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; INNER JOIN tag_info AS info ON info.tag_config_params_recid = config.tag_config_params_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; WHERE info.tag_serial_num = ? AND info.organization_id = ?;&#39;</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getResult</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">[</span><span class="nx">serialNum</span><span class="p">,</span> <span class="nx">orgID</span><span class="p">],</span>
    <span class="nx">cb</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTagsByOrgId</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">organizationID</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validator</span><span class="p">.</span><span class="nx">isUUID4</span><span class="p">(</span><span class="nx">organizationID</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="k">this</span>
      <span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;badRequest&#39;</span><span class="p">)),</span> <span class="nx">i18n</span><span class="p">.</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;users.invalid-uuid&#39;</span><span class="p">),</span> <span class="p">{</span>
      <span class="nx">organizationID</span><span class="o">:</span> <span class="nx">i18n</span><span class="p">.</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;users.invalid-uuid&#39;</span><span class="p">)</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getQueryForAllTags</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">getResults</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">[</span><span class="nx">organizationID</span><span class="p">],</span>
    <span class="nx">isGrid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">cb</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">queryResult</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">queryResult</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;notFound&#39;</span><span class="p">),</span>
          <span class="s1">&#39;No tags found with organization id - &#39;</span> <span class="o">+</span> <span class="nx">organizationID</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">queryResult</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">checkIfExists</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagSN</span><span class="p">,</span> <span class="nx">orgID</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">tagSN</span><span class="p">)</span> <span class="o">||</span> <span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">orgID</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;badRequest&#39;</span><span class="p">),</span> 
            <span class="s1">&#39;Please provide the tag serial number and the organization ID.&#39;</span><span class="p">,</span> <span class="p">{}));</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span> <span class="s1">&#39;SELECT tag_info_recid AS ID FROM tag_info WHERE organization_id = ? AND tag_serial_num = ?;&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">getResult</span><span class="p">({</span>
    <span class="nx">query</span> <span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span> <span class="o">:</span> <span class="p">[</span><span class="nx">tagSN</span><span class="p">,</span> <span class="nx">orgID</span><span class="p">],</span>
    <span class="nx">cb</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="p">}</span>      
    <span class="p">}</span>
  <span class="p">});</span>  
<span class="p">};</span>

<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTagById</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagId</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getQueryForAllTags</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">getResults</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">[</span><span class="nx">tagId</span><span class="p">],</span>
    <span class="nx">isGrid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">cb</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">queryResult</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">queryResult</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;notFound&#39;</span><span class="p">),</span>
          <span class="s1">&#39;No tag was found with tag id - &#39;</span> <span class="o">+</span> <span class="nx">tagId</span><span class="p">,</span> <span class="p">{});</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">queryResult</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getQueryForAllTags</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">isIndTag</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">condition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isIndTag</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="o">=</span> <span class="s1">&#39; WHERE tag_info.tag_info_recid = ?&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span> <span class="s1">&#39;SELECT&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; &quot;Emanate powerpath 100&quot;        AS  &quot;tagType&quot;,  &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.tag_info_recid AS &quot;tagID&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.hardware_version      AS  &quot;hwVersion&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.host_firmware_version AS &quot;fwVersion&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.tag_manufacturer_name AS &quot;name&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.tag_serial_num        AS &quot;serialNum&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.wifi_macaddr          AS &quot;macAddress&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.device_id             AS &quot;deviceID&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.created_on AS &quot;firstSeen&quot;, &#39;</span><span class="o">+</span>
    <span class="s1">&#39; CONCAT(tag_info.commissioned_on, &quot;(&quot;, DATEDIFF(NOW(), tag_info.commissioned_on), &quot;days&quot;)  AS &quot;firstSeen&quot;,    &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; CASE WHEN tag_info.is_commissioned = 1 THEN &quot;OK&quot;&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; ELSE &quot;Not commissioned&quot;&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; END  AS &quot;configStatus&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; (SELECT CONCAT(lookup_value_display, &quot; Since yesterday &quot;, TIME_FORMAT(tag_info.last_maintenance_date, &quot;%h:%i %p&quot;))&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; FROM tag_lookup_table&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; WHERE lookup_value_id = tag_maint_call.tag_usage_info_id_enum&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; AND lookup_key = &quot;powerPathUsageInfo&quot; )   AS &quot;deviceStatus&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; &quot;None&quot; AS &quot;alerts&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_maint_call.battery_level_percent AS &quot;batteryLevel&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.last_maintenance_date  AS &quot;lastSeen&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.device_last_used_on    AS  &quot;lastUsed&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_info.nearest_ap_rssi_dbm  AS &quot;nearestAp&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; CONCAT(&quot;Tomorrow &quot;, TIME (DATE_ADD(tag_info.last_maintenance_date, INTERVAL 1 DAY))) AS &quot;nextMaintCall&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; IFNULL((SELECT GROUP_CONCAT(event_type_id_enum)&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; FROM pending_events&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; WHERE organization_id = tag_info.organization_id&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; AND tag_srno = tag_info.tag_serial_num&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; AND is_processed = 0&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; AND is_active = 1), &quot;none&quot;) AS &quot;pendingCommands&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; &quot;1.2 days&quot; AS &quot;avgTimeBetweenUses&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; &quot;1.3 hours&quot; AS &quot;avgUsageDuration&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_maint_call.util_percent_6months  AS &quot;utilization&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; &quot;1.73 kWh&quot; AS &quot;dailyEnergyConsumption&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; (SELECT voltage_level * tag_maint_call.util_percent_1day&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;  FROM country_m&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; INNER JOIN organization_m ON country_m.country_recid = organization_m.country_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;  WHERE organization_m.organization_id = tag_info.organization_id) AS &quot;dailyEnergyConsumption&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; wifi_network_params.server_url  AS &quot;server&quot;,          &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; wifi_network_params.tag_static_ip_addr  AS &quot;ipAddress&quot;,  &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; wifi_network_params.network_ssid  AS &quot;SSID&quot;,       &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; wifi_network_params.network_security AS &quot;encryption&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_params.wifi_ccx_channels  AS &quot;channels&quot;,  &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; &quot;CCX&quot; AS &quot;protocol&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_params.accel_motion_time_sec   AS &quot;interval&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_params.wifi_num_pkts_per_chan  AS &quot;repetitionsPerChannel&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; &quot;Enabled&quot;                                 AS &quot;motionSensorTrigger&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; &quot;After motion&quot;                            AS &quot;motionUpdateMethod&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_params.accel_motion_update_sec AS &quot;motionUpdateInterval&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_params.wifi_ccx_channels  AS &quot;channels&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_params.maint_interval_pluggedin_sec  AS &quot;intervalTagPluggedInSec&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_params.maint_interval_unplugged_sec AS &quot;intervalTagunPluggedInHr&quot;, &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_params.pluggedin_actions AS &quot;maintCallOnPlugIn&quot;,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_params.push_button_actions AS &quot;MaintCallOnButtonPress&quot;  &#39;</span> <span class="o">+</span> <span class="s1">&#39; FROM tag_info&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; LEFT OUTER JOIN tag_maint_call ON tag_info.organization_id = tag_maint_call.organization_id&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; AND tag_info.tag_serial_num = tag_maint_call.tag_srno &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; AND tag_info.last_tag_maint_call_recid  = tag_maint_call.tag_maint_call_recid&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; LEFT OUTER JOIN tag_config_params ON tag_info.tag_config_params_recid = tag_config_params.tag_config_params_recid &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; LEFT OUTER JOIN  wifi_network_params ON tag_config_params.wifi_network_params_recid = wifi_network_params.wifi_network_params_recid  &#39;</span>
    <span class="o">+</span><span class="s1">&#39; WHERE tag_info.organization_recid = ? &#39;</span>
    <span class="o">+</span> <span class="nx">condition</span><span class="p">;</span>
  <span class="nx">sqlQuery</span> <span class="o">+=</span> <span class="s1">&#39;;&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">sqlQuery</span><span class="p">;</span>
<span class="p">};</span>


<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">insertTagInfo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagInfo</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span>
    <span class="s1">&#39;INSERT INTO tag_info (tag_info_recid, cassandra_dump_rec_id, tag_serial_num, organization_id,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;device_id, customer_id, hardware_version, wifi_macaddr, tag_config_state_id_enum, hw_peripherals,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;host_firmware_version, wifi_firmware_version, ble_firmware_version, tag_config_version,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;factory_test_time,config_time, created_on, created_by)&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; VALUES (:id, :dmpRecID, :tagSN, :organizationID, :deviceID, :customerID, :hardwareVersion, :wifiMacAddr, :tagConfigState,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; :hwPeripherals, :hostFirmwareVer, :wifiFirmwareVer, :bleFirwareVer, :powerPathConfigVer, :factoryTestTime, :configTime,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; :createdOn, :createdBy)&#39;</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">tagInfo</span><span class="p">,</span>
    <span class="nx">cb</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">tagInfoID</span><span class="o">:</span> <span class="nx">tagInfo</span><span class="p">.</span><span class="nx">id</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>


<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateTagInfo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagInfo</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span>
    <span class="s1">&#39;UPDATE tag_info SET cassandra_dump_rec_id = :dmpRecID, organization_id = :organizationID, device_id = :deviceID,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; customer_id = :customerID, hardware_version = :hardwareVersion, wifi_macaddr = :wifiMacAddr,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_config_state_id_enum =:tagConfigState, hw_peripherals = :hwPeripherals, host_firmware_version = :hostFirmwareVer,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; wifi_firmware_version = :wifiFirmwareVer, ble_firmware_version = :bleFirwareVer, tag_config_version = :powerPathConfigVer,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; factory_test_time = :factoryTestTime, config_time = :configTime, modified_on = :createdOn, modified_by = :createdBy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; WHERE tag_serial_num = :tagSN&#39;</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">tagInfo</span><span class="p">,</span>
    <span class="nx">cb</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">tagInfoID</span><span class="o">:</span> <span class="nx">tagInfo</span><span class="p">.</span><span class="nx">id</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>


<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateLastMaintCallDetails</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">maintData</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">transactionID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">maintData</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;transactionID&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">transactionID</span> <span class="o">=</span> <span class="nx">maintData</span><span class="p">.</span><span class="nx">transactionID</span><span class="p">;</span>
    <span class="nx">maintData</span> <span class="o">=</span> <span class="nx">maintData</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span>
    <span class="s1">&#39;UPDATE tag_info SET device_last_used_on = CASE WHEN :powerPathUsageState = 4&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; THEN :currentTimeStamp ELSE NULL END, last_maintenance_date = :createdOn, last_tag_maint_call_recid  = :id&#39;</span> <span class="o">+</span>
    <span class="s1">&#39; WHERE tag_serial_num = :tagSN AND organization_id = :organizationID AND is_active = 1&#39;</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">maintData</span><span class="p">,</span>
    <span class="nx">transactionID</span><span class="o">:</span> <span class="nx">transactionID</span><span class="p">,</span>
    <span class="nx">validate</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">cb</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">maintDataID</span><span class="o">:</span> <span class="nx">maintData</span><span class="p">.</span><span class="nx">id</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>


<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTagByTagSN</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagSN</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span>
    <span class="s1">&#39;SELECT cassandra_dump_rec_id AS dmpRecID, organization_id AS organizationID, device_id AS deviceID,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;customer_id AS customerID, hardware_version AS hardwareVersion, wifi_macaddr AS wifiMacAddr,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;tag_config_state_id_enum AS tagConfigState, hw_peripherals AS hwPeripherals, host_firmware_version AS hostFirmwareVer,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;wifi_firmware_version AS wifiFirmwareVer, ble_firmware_version AS bleFirwareVer, tag_config_version AS powerPathConfigVer,&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;factory_test_time AS factoryTestTime, config_time AS configTime &#39;</span> <span class="o">+</span>
    <span class="s1">&#39;FROM tag_info where tag_serial_num = ?&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">getResult</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">[</span><span class="nx">tagSN</span><span class="p">],</span>
    <span class="nx">cb</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">queryResult</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">queryResult</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>


<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTagOrgID</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagSN</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span> <span class="s1">&#39;SELECT organization_id AS organizationID FROM tag_info WHERE &#39;</span> <span class="o">+</span>
    <span class="s1">&#39; tag_serial_num = ? AND is_active = ?&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">getResult</span><span class="p">({</span>
    <span class="nx">query</span> <span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span> <span class="o">:</span> <span class="p">[</span><span class="nx">tagSN</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActiveID</span><span class="p">()],</span>
    <span class="nx">cb</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">queryResult</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">__</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">queryResult</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">queryResult</span><span class="p">.</span><span class="nx">organizationID</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createNewTagViaMaint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagObj</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">validateProp</span><span class="p">(</span><span class="nx">tagObj</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tagSN&#39;</span><span class="p">,</span> <span class="s1">&#39;dmpRecID&#39;</span><span class="p">,</span> <span class="s1">&#39;organizationID&#39;</span><span class="p">,</span> <span class="s1">&#39;organizationRecID&#39;</span><span class="p">]);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;badRequest&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Please provide the dump record ID, serial number and organization ID.&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">sqlQuery</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO tag_info (tag_info_recid, cassandra_dump_rec_id, tag_serial_num, nearest_ap_macaddr, &#39;</span>  
    <span class="o">+</span> <span class="s1">&#39;nearest_ap_rssi_dbm, tag_config_state_id_enum, organization_id, organization_recid, is_commissioned, is_active, created_on, created_by) &#39;</span>
    <span class="o">+</span> <span class="s1">&#39;VALUES (:id, :dmpRecID,:tagSN,:nearestAPMacAddr, :nearestAP_RSSI_DBM, &#39;</span>  
    <span class="o">+</span> <span class="s1">&#39;(SELECT lookup_value_id FROM tag_lookup_table WHERE lookup_value_vc = \&#39;TAG_CONFIG_STATE_ACTIVATED\&#39;&#39;</span>
    <span class="o">+</span> <span class="s1">&#39; AND lookup_key = \&#39;powerPathConfigState\&#39;), &#39;</span>
    <span class="o">+</span> <span class="s1">&#39; :organizationID , :organizationRecID, :isCommissioned, :isActive, :createdOn, :createdBy);&#39;</span><span class="p">;</span> 
  <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">({</span>
    <span class="nx">query</span> <span class="o">:</span> <span class="nx">sqlQuery</span><span class="p">,</span>
    <span class="nx">data</span> <span class="o">:</span> <span class="nx">tagObj</span><span class="p">,</span>
    <span class="nx">validate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">cb</span> <span class="o">:</span> <span class="nx">cb</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getDefaultTagInfo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">currDate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dbUtils</span><span class="p">.</span><span class="nx">toMySQLDateTime</span><span class="p">();</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">id</span><span class="o">:</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">(),</span>
    <span class="nx">createdOn</span><span class="o">:</span> <span class="nx">currDate</span><span class="p">,</span>
    <span class="nx">createdBy</span><span class="o">:</span> <span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">default_created_by</span>
  <span class="p">};</span>
<span class="p">};</span>


<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getDefaultMaintInsertObj</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">currDate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dbUtils</span><span class="p">.</span><span class="nx">toMySQLDateTime</span><span class="p">();</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">:</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">(),</span>
    <span class="nx">createdOn</span> <span class="o">:</span> <span class="nx">currDate</span><span class="p">,</span>
    <span class="nx">createdBy</span> <span class="o">:</span> <span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">default_created_by</span><span class="p">,</span>
    <span class="nx">isActive</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActiveID</span><span class="p">(),</span>
    <span class="nx">isCommissioned</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getUncommissionedFlag</span><span class="p">(),</span>
    <span class="nx">nearestAPRSSIdBm</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="nx">nearestAPMACAddr</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span>
  <span class="p">};</span>
<span class="p">};</span>


<span class="nx">Tag</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getUncommissionedFlag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Tag</span><span class="p">;</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
