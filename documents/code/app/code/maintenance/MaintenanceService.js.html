<!DOCTYPE html>
<html>
<head>
  <title>MaintenanceService.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../", thisFile = "app/code/maintenance/MaintenanceService.js", defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>
  <script src="../../../fileSearch.js"></script>
  <link rel="stylesheet" href="../../../fileSearch.css" />
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>MaintenanceService.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Service</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_base_path</span> <span class="o">+</span> <span class="s1">&#39;lib/service&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">PIMService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_code_path</span> <span class="o">+</span> <span class="s1">&#39;pim/PIMService&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">histogramService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_code_path</span> <span class="o">+</span>
  <span class="s1">&#39;histogram/HistogramService&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">currentService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_code_path</span> <span class="o">+</span>
  <span class="s1">&#39;current/CurrentService&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">tagService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_code_path</span> <span class="o">+</span> <span class="s1">&#39;tags/TagService&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">AppError</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_base_path</span> <span class="o">+</span> <span class="s1">&#39;lib/app-error&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Maintenance</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_code_path</span> <span class="o">+</span> <span class="s1">&#39;maintenance/Maintenance&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pendingEvent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_code_path</span> <span class="o">+</span> <span class="s1">&#39;pending_events/PendingEventService&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Helper</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_code_path</span> <span class="o">+</span>
  <span class="s1">&#39;maintenance/MaintenanceServiceHelper&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_base_path</span> <span class="o">+</span> <span class="s1">&#39;logger&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Tag</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">app_code_path</span> <span class="o">+</span> <span class="s1">&#39;tags/Tag&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">__</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">i18n</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;i18n&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">MaintenanceService</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Service</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">MaintenanceService</span><span class="p">,</span> <span class="nx">Service</span><span class="p">);</span>

<span class="nx">MaintenanceService</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">CONFIG</span> <span class="o">=</span> <span class="nx">__CONFIG__</span><span class="p">.</span><span class="nx">maintenance</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Handles tag's POST call</p>
  </div>
  <div class="body"><ol>
<li>Normalizes the data to ensure all the properties are available</li>
<li>Populate the default values in the data sent by the tag.</li>
<li>Insert the data into Cassandra
<ul><li>Call the method to process the data in Cassandra.</li></ul></li>
<li>Check if the tag belongs to the correct organization ID</li>
<li><ul><li>If the tag does not exists, create the tag and add the Tag Info event.</li></ul></li>
<li><ul><li>If the tag exists, but belongs to another organization. Complain.</li></ul></li>
<li>Check if it's a maintenance event
<ul><li>If it's a maintenance call, fetch the pending events and send it off.</li>
<li>Add the tag info event again (It needs to be sent for every maintenance call)</li></ul></li>
<li>Its' not a maintenance event, just send an acknowledgement to the tag.</li>
</ol>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">serviceObj</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cntrlCb
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">MaintenanceService</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processTagPost</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">,</span> <span class="nx">cntrlCb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mMaintenance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Maintenance</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">serviceObj</span> <span class="o">=</span> <span class="nx">Helper</span><span class="p">.</span><span class="nx">normalizeTagData</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Here if the type, orgID or tagSN are not sent, a default value will be assigned 
to them but the data will also be marked as invalid.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">serviceObj</span> <span class="o">=</span> <span class="nx">__</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">,</span> <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">getDefaultMaintObj</span><span class="p">());</span>
  <span class="kd">var</span> <span class="nx">isInvalidMaintObj</span> <span class="o">=</span> <span class="nx">Helper</span><span class="p">.</span><span class="nx">isDefaultMaintObj</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>The data goes into Cassandra in a string format.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">serviceObj</span><span class="p">.</span><span class="nx">strData</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">dmpRecID</span> <span class="o">=</span> <span class="nx">serviceObj</span><span class="p">.</span><span class="nx">dmpRecID</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">sTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tagService</span><span class="p">();</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Insert the tag maintenance into Cassandra</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">insertTagMaint</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>If the data is not completely valid - skip inserting in Maria        </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isInvalidMaintObj</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">CONFIG</span><span class="p">.</span><span class="nx">run_maria_on_main</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">processPostData</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">,</span> <span class="nx">dmpRecID</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>TODO : Fork a child process and call
MaintenanceService.processMaintRecord()</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">async</span><span class="p">.</span><span class="nx">waterfall</span><span class="p">([</span><span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Check if the tag exists.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">sTag</span><span class="p">.</span><span class="nx">checkIfTagBelongsToOrg</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">.</span><span class="nx">tagSN</span><span class="p">,</span> <span class="nx">serviceObj</span><span class="p">.</span><span class="nx">organizationID</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>    
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">existsObj</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">exists</span> <span class="o">=</span> <span class="nx">existsObj</span><span class="p">.</span><span class="nx">exists</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">belongsToOrg</span> <span class="o">=</span> <span class="nx">existsObj</span><span class="p">.</span><span class="nx">belongsToOrg</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exists</span> <span class="o">!==</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isInvalidMaintObj</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>It doesn't exist, and the primary data sent by it is not 
invalid...Create the tag, insert the pending event - tagInfo</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sTag</span><span class="p">.</span><span class="nx">createNewTagViaMaint</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">});</span>        
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">exists</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">belongsToOrg</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>The tag exists but does not belong to the given organization.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">next</span><span class="p">(</span><span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;badRequest&#39;</span><span class="p">),</span> 
              <span class="s1">&#39;The tag with the given serial number does not belong to that organization.&#39;</span><span class="p">,</span> <span class="p">{}));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>Already exists, nothing to do...</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Check if it's a maintenance event and send the pending events.
Send only if it's a valid maintenance object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">serviceObj</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isInvalidMaintObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">sPendingEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pendingEvent</span><span class="p">();</span>
      <span class="nx">sPendingEvent</span><span class="p">.</span><span class="nx">getTagPendingEvents</span><span class="p">(</span><span class="nx">serviceObj</span><span class="p">.</span><span class="nx">tagSN</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">Helper</span><span class="p">.</span><span class="nx">formatPendingEvents</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Insert Tag Info event again because it's suppose 
to be sent for every maintenance call.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">sPendingEvent</span><span class="p">.</span><span class="nx">insertTagInfoEvent</span><span class="p">({</span>
          <span class="nx">tagSN</span> <span class="o">:</span> <span class="nx">serviceObj</span><span class="p">.</span><span class="nx">tagSN</span><span class="p">,</span>
          <span class="nx">organizationID</span> <span class="o">:</span> <span class="nx">serviceObj</span><span class="p">.</span><span class="nx">organizationID</span>
        <span class="p">},</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>It's not a maintenance event, tag doesn't need any more info, just send
an ACK informing that the data was received, currently
piggy backing whatever was sent.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">serviceObj</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cntrlCb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">MaintenanceService</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processPostData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagMaintData</span><span class="p">,</span> <span class="nx">dmpRecID</span><span class="p">,</span>
  <span class="nx">cntrlCb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">organizationID</span> <span class="o">=</span> <span class="nx">tagMaintData</span><span class="p">.</span><span class="nx">organizationID</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">tagSN</span> <span class="o">=</span> <span class="nx">tagMaintData</span><span class="p">.</span><span class="nx">tagSN</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">typeOfData</span> <span class="o">=</span> <span class="nx">tagMaintData</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">dataToSend</span> <span class="o">=</span> <span class="nx">tagMaintData</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="nx">dataToSend</span><span class="p">.</span><span class="nx">dmpRecID</span> <span class="o">=</span> <span class="nx">dmpRecID</span><span class="p">;</span>
  <span class="nx">dataToSend</span><span class="p">.</span><span class="nx">tagSN</span> <span class="o">=</span> <span class="nx">tagSN</span><span class="p">;</span>
  <span class="nx">dataToSend</span><span class="p">.</span><span class="nx">organizationID</span> <span class="o">=</span> <span class="nx">organizationID</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">sTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tagService</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>First checking if the organization and tag SN are valid</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">async</span><span class="p">.</span><span class="nx">waterfall</span><span class="p">([</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>      
      <span class="nx">sTag</span><span class="p">.</span><span class="nx">checkIfTagBelongsToOrg</span><span class="p">(</span><span class="nx">organizationID</span><span class="p">,</span> <span class="nx">tagSN</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">existsObj</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">exists</span> <span class="o">=</span> <span class="nx">existsObj</span><span class="p">.</span><span class="nx">exists</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">belongsToOrg</span> <span class="o">=</span> <span class="nx">existsObj</span><span class="p">.</span><span class="nx">belongsToOrg</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">(</span><span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;badRequest&#39;</span><span class="p">),</span>
            <span class="s1">&#39;An non existant tag\&#39;s data was sent for processing.&#39;</span><span class="p">,</span> <span class="p">{}),</span>
          <span class="kc">null</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">exists</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">belongsToOrg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">(</span><span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;badRequest&#39;</span><span class="p">),</span> 
                <span class="s1">&#39;The tag with the given serial number does not belong to that organization.&#39;</span><span class="p">,</span> <span class="p">{}));</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">typeOfData</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">insertMaintData</span><span class="p">(</span><span class="nx">dataToSend</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">typeOfData</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sHistogram</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">histogramService</span><span class="p">();</span>
        <span class="nx">dataToSend</span><span class="p">.</span><span class="nx">strData</span> <span class="o">=</span> <span class="nx">tagMaintData</span><span class="p">.</span><span class="nx">strData</span><span class="p">;</span>
        <span class="nx">sHistogram</span><span class="p">.</span><span class="nx">insertHistogramInfo</span><span class="p">(</span><span class="nx">dataToSend</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">typeOfData</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sPIM</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PIMService</span><span class="p">();</span>
        <span class="nx">sPIM</span><span class="p">.</span><span class="nx">insertPIMInfo</span><span class="p">(</span><span class="nx">dataToSend</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">typeOfData</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sCurrent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">currentService</span><span class="p">();</span>
        <span class="nx">sCurrent</span><span class="p">.</span><span class="nx">insertCurrentData</span><span class="p">(</span><span class="nx">dataToSend</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">typeOfData</span> <span class="o">===</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>     
        <span class="nx">sTag</span><span class="p">.</span><span class="nx">processTagInfo</span><span class="p">(</span><span class="nx">dataToSend</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">typeOfData</span> <span class="o">===</span> <span class="nx">that</span><span class="p">.</span><span class="nx">CONFIG</span><span class="p">.</span><span class="nx">default_value_type</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">checkAndRespond</span><span class="p">(</span><span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span>
              <span class="s1">&#39;badRequest&#39;</span><span class="p">),</span>
            <span class="nx">i18n</span><span class="p">.</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;tags.invalid-datatype&#39;</span><span class="p">),</span> <span class="p">{}));</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">processResponse</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Processes the response after the operation on the tag's data has been performed.
It either sets the processed flag or the error flag on the cassandra record.
If setting the error/success flag fails, it writes an entry in the maintenance log
file.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">err</span>
      <span class="dox_type">object</span>
      <span>Error object. Indicates that there was an error while processing
the cassandra record.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">object</span>
      <span>The data that is returned after processing of the record.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">processResponse</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mMaintenance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Maintenance</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">trialCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tagMaintData</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;trialCount&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">trialCount</span> <span class="o">=</span> <span class="nx">tagMaintData</span><span class="p">.</span><span class="nx">trialCount</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">respObj</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">dmpRecID</span><span class="o">:</span> <span class="nx">dmpRecID</span><span class="p">,</span>
      <span class="nx">trialCount</span><span class="o">:</span> <span class="nx">trialCount</span><span class="p">,</span>
      <span class="nx">organizationID</span><span class="o">:</span> <span class="nx">organizationID</span>
    <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">respObj</span><span class="p">.</span><span class="nx">err</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
      <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">setErrorFlag</span><span class="p">(</span><span class="nx">respObj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">updateErr</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">updateErr</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fErr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;internalError&#39;</span><span class="p">),</span>
            <span class="nx">i18n</span><span class="p">.</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;tags.failed-set-errorflag&#39;</span><span class="p">),</span> <span class="p">{</span>
              <span class="s1">&#39;recID&#39;</span><span class="o">:</span> <span class="nx">dmpRecID</span><span class="p">,</span>
              <span class="s1">&#39;err&#39;</span><span class="o">:</span> <span class="nx">err</span><span class="p">,</span>
              <span class="s1">&#39;csErr&#39;</span><span class="o">:</span> <span class="nx">updateErr</span>
            <span class="p">});</span>
          <span class="k">return</span> <span class="nx">checkAndRespond</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">writeMaintenanceLog</span><span class="p">(</span><span class="nx">fErr</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">checkAndRespond</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">setProcessedTag</span><span class="p">(</span><span class="nx">respObj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span>
        <span class="nx">updateErr</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">updateErr</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fErr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppError</span><span class="p">(</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">getStatusCode</span><span class="p">(</span><span class="s1">&#39;internalError&#39;</span><span class="p">),</span>
            <span class="nx">i18n</span><span class="p">.</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;tags.failed-set-processedflag&#39;</span><span class="p">),</span> <span class="p">{</span>
              <span class="s1">&#39;recID&#39;</span><span class="o">:</span> <span class="nx">dmpRecID</span><span class="p">,</span>
              <span class="s1">&#39;err&#39;</span><span class="o">:</span> <span class="nx">err</span><span class="p">,</span>
              <span class="s1">&#39;csErr&#39;</span><span class="o">:</span> <span class="nx">updateErr</span>
            <span class="p">});</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">writeMaintenanceLog</span><span class="p">(</span><span class="nx">fErr</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">checkAndRespond</span><span class="p">(</span><span class="nx">fErr</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">checkAndRespond</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">checkAndRespond</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cntrlCb</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cntrlCb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">MaintenanceService</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">writeMaintenanceLog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;Message : &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">appMessage</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">baseError</span> <span class="o">=</span> <span class="s1">&#39;Base Error : &#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">recordID</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">validation</span><span class="p">.</span><span class="nx">recID</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">validation</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">baseError</span> <span class="o">+=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">baseError</span> <span class="o">+=</span> <span class="s1">&#39;None&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">baseError</span> <span class="o">+=</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">csError</span> <span class="o">=</span> <span class="s1">&#39;Cassandra Error : &#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">validation</span><span class="p">.</span><span class="nx">csErr</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">csError</span> <span class="o">+=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">validation</span><span class="p">.</span><span class="nx">csErr</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">csError</span> <span class="o">+=</span> <span class="s1">&#39;None&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">csError</span> <span class="o">+=</span> <span class="s1">&#39;\n\n&#39;</span><span class="p">;</span>
  <span class="nx">logger</span><span class="p">.</span><span class="nx">logMaintError</span><span class="p">(</span><span class="nx">recordID</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="nx">baseError</span> <span class="o">+</span> <span class="nx">csError</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">err</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">MaintenanceService</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getFailedRecords</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cntrlCb</span><span class="p">)</span> <span class="p">{</span>

<span class="p">};</span>

<span class="nx">MaintenanceService</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">insertMaintData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">maintData</span><span class="p">,</span> <span class="nx">cntrlCb</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>TODO : Any validations?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">mMaintenance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Maintenance</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">transactionID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="nx">async</span><span class="p">.</span><span class="nx">waterfall</span><span class="p">([</span><span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">beginTransaction</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">mMaintenance</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span>
    <span class="nx">tID</span><span class="p">,</span>
    <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">transactionID</span> <span class="o">=</span> <span class="nx">tID</span><span class="p">;</span>
    <span class="nx">maintData</span><span class="p">.</span><span class="nx">currentTimeStamp</span> <span class="o">=</span> <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">convertTagTimeStamp</span><span class="p">(</span>
      <span class="nx">maintData</span><span class="p">.</span><span class="nx">currentTimeStamp</span><span class="p">);</span>
    <span class="nx">maintData</span><span class="p">.</span><span class="nx">batteryChargeTimestamp</span> <span class="o">=</span> <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">convertTagTimeStamp</span><span class="p">(</span>
      <span class="nx">maintData</span><span class="p">.</span><span class="nx">batteryChargeTimestamp</span><span class="p">);</span>
    <span class="nx">maintData</span><span class="p">.</span><span class="nx">motionDetStartTimestamp</span> <span class="o">=</span> <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">convertTagTimeStamp</span><span class="p">(</span>
      <span class="nx">maintData</span><span class="p">.</span><span class="nx">motionDetStartTimestamp</span><span class="p">);</span>
    <span class="nx">maintData</span><span class="p">.</span><span class="nx">chokePointInfo</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">convertTagTimeStamp</span><span class="p">(</span>
      <span class="nx">maintData</span><span class="p">.</span><span class="nx">chokePointInfo</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>

    <span class="nx">maintData</span> <span class="o">=</span> <span class="nx">__</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">maintData</span><span class="p">,</span> <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">getDefaultMaintData</span><span class="p">());</span>
    <span class="nx">maintData</span> <span class="o">=</span> <span class="nx">__</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">maintData</span><span class="p">.</span><span class="nx">batteryInfo</span><span class="p">,</span> <span class="nx">maintData</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>move the batteryinfo elements to the root to be inserted into table tag_maint_call</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">maintData</span> <span class="o">=</span> <span class="nx">__</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">maintData</span><span class="p">.</span><span class="nx">currentUtil</span><span class="p">,</span> <span class="nx">maintData</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>move the currentUtil elements to the root to be inserted into table tag_maint_call</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">maintData</span> <span class="o">=</span> <span class="nx">__</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">maintData</span><span class="p">.</span><span class="nx">chokePointInfo</span><span class="p">,</span> <span class="nx">maintData</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>move the currentUtil elements to the root to be inserted into table tag_maint_call</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">transactionID</span><span class="o">:</span> <span class="nx">transactionID</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">maintData</span>
    <span class="p">};</span>
    <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">insertMaintData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">maintDataID</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">maintBleEvents</span> <span class="o">=</span> <span class="nx">maintData</span><span class="p">.</span><span class="nx">bleEvents</span><span class="p">;</span>
    <span class="nx">maintBleEvents</span><span class="p">.</span><span class="nx">tagMaintCallRecID</span> <span class="o">=</span> <span class="nx">maintDataID</span><span class="p">;</span>
    <span class="nx">maintBleEvents</span> <span class="o">=</span> <span class="nx">__</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">maintBleEvents</span><span class="p">,</span> <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">getDefaultBleEvents</span><span class="p">());</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">transactionID</span><span class="o">:</span> <span class="nx">transactionID</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">maintBleEvents</span>
    <span class="p">};</span>
    <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">insertBleEvents</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">maintDataID</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tag</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">transactionID</span><span class="o">:</span> <span class="nx">transactionID</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">maintData</span>
    <span class="p">};</span>
    <span class="nx">mTag</span><span class="p">.</span><span class="nx">updateLastMaintCallDetails</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">commitTransaction</span><span class="p">(</span><span class="nx">transactionID</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
  <span class="p">}],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">mMaintenance</span><span class="p">.</span><span class="nx">rollbackTransaction</span><span class="p">(</span><span class="nx">transactionID</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">cntrlCb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">MaintenanceService</span><span class="p">;</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
